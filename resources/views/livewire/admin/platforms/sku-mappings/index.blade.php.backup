<?php

use App\Models\Platform;
use App\Models\PlatformSkuMapping;
use App\Models\Product;
use Livewire\Volt\Component;
use Livewire\WithPagination;

new class extends Component {
    use WithPagination;

    public string $search = '';
    public string $platformFilter = '';
    public string $statusFilter = '';
    public string $productFilter = '';
    public string $sortBy = 'updated_at';
    public string $sortDirection = 'desc';

    public function mount()
    {
        //
    }

    public function updatedSearch()
    {
        $this->resetPage();
    }

    public function updatedPlatformFilter()
    {
        $this->resetPage();
    }

    public function updatedStatusFilter()
    {
        $this->resetPage();
    }

    public function updatedProductFilter()
    {
        $this->resetPage();
    }

    public function sortBy($field)
    {
        if ($this->sortBy === $field) {
            $this->sortDirection = $this->sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            $this->sortBy = $field;
            $this->sortDirection = 'asc';
        }
        $this->resetPage();
    }

    public function toggleStatus($mappingId)
    {
        $mapping = PlatformSkuMapping::findOrFail($mappingId);
        $mapping->update(['is_active' => !$mapping->is_active]);

        $this->dispatch('mapping-updated',
            message: $mapping->is_active ? 'SKU mapping activated' : 'SKU mapping deactivated'
        );
    }

    public function deleteMapping($mappingId)
    {
        PlatformSkuMapping::findOrFail($mappingId)->delete();
        $this->dispatch('mapping-deleted', message: 'SKU mapping deleted successfully');
    }

    public function getMappingsProperty()
    {
        return PlatformSkuMapping::query()
            ->with(['platform', 'product', 'productVariant', 'platformAccount'])
            ->when($this->search, function ($query) {
                $query->where(function ($q) {
                    $q->where('platform_sku', 'like', '%' . $this->search . '%')
                      ->orWhere('platform_product_name', 'like', '%' . $this->search . '%')
                      ->orWhere('platform_variation_name', 'like', '%' . $this->search . '%')
                      ->orWhereHas('product', fn($productQuery) =>
                          $productQuery->where('name', 'like', '%' . $this->search . '%')
                                       ->orWhere('sku', 'like', '%' . $this->search . '%')
                      );
                });
            })
            ->when($this->platformFilter, fn($query) =>
                $query->where('platform_id', $this->platformFilter)
            )
            ->when($this->statusFilter !== '', fn($query) =>
                $query->where('is_active', $this->statusFilter === '1')
            )
            ->when($this->productFilter, function ($query) {
                $query->where(function ($q) {
                    $q->where('product_id', $this->productFilter)
                      ->orWhere('product_variant_id', $this->productFilter);
                });
            })
            ->orderBy($this->sortBy, $this->sortDirection)
            ->paginate(20);
    }

    public function getPlatformsProperty()
    {
        return Platform::all();
    }

    public function getProductsProperty()
    {
        return Product::with('variants')->get();
    }

    public function with(): array
    {
        return [
            'mappings' => $this->mappings,
            'platforms' => $this->platforms,
            'products' => $this->products,
        ];
    }
}; ?>

<x-admin.layout title="SKU Mappings">
    <div class="mb-6 flex items-center justify-between">
        <div>
            <flux:heading size="xl">SKU Mappings</flux:heading>
            <flux:text class="mt-2">Manage platform SKU mappings to link external products with your inventory</flux:text>
        </div>
        <flux:button variant="primary" :href="route('platforms.sku-mappings.create')" wire:navigate>
            <flux:icon name="plus" class="w-4 h-4 mr-2" />
            Create Mapping
        </flux:button>
    </div>

    <!-- Filters -->
    <div class="mb-6 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-5">
        <flux:input
            wire:model.live.debounce.300ms="search"
            placeholder="Search SKUs, products..."
            clearable
        />

        <flux:select wire:model.live="platformFilter" placeholder="All Platforms">
            <flux:option value="">All Platforms</flux:option>
            @foreach($platforms as $platform)
                <flux:option value="{{ $platform->id }}">{{ $platform->name }}</flux:option>
            @endforeach
        </flux:select>

        <flux:select wire:model.live="statusFilter" placeholder="All Status">
            <flux:option value="">All Status</flux:option>
            <flux:option value="1">Active</flux:option>
            <flux:option value="0">Inactive</flux:option>
        </flux:select>

        <flux:select wire:model.live="productFilter" placeholder="All Products">
            <flux:option value="">All Products</flux:option>
            @foreach($products as $product)
                <flux:option value="{{ $product->id }}">{{ $product->name }}</flux:option>
                @foreach($product->variants as $variant)
                    <flux:option value="{{ $variant->id }}">{{ $product->name }} - {{ $variant->name }}</flux:option>
                @endforeach
            @endforeach
        </flux:select>

        <div class="flex items-center space-x-2">
            <flux:button
                variant="outline"
                size="sm"
                wire:click="$refresh"
            >
                <flux:icon name="arrow-path" class="w-4 h-4" />
            </flux:button>
        </div>
    </div>

    <!-- Mappings Table -->
    <div class="overflow-hidden rounded-lg border border-zinc-200 bg-white">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-zinc-200">
                <thead class="bg-zinc-50">
                    <tr>
                        <th wire:click="sortBy('platform_sku')" class="cursor-pointer px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-zinc-500 hover:bg-zinc-100">
                            <div class="flex items-center space-x-1">
                                <span>Platform SKU</span>
                                @if($sortBy === 'platform_sku')
                                    <flux:icon name="{{ $sortDirection === 'asc' ? 'chevron-up' : 'chevron-down' }}" class="w-3 h-3" />
                                @endif
                            </div>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-zinc-500">
                            Platform
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-zinc-500">
                            Product / Variant
                        </th>
                        <th wire:click="sortBy('usage_count')" class="cursor-pointer px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-zinc-500 hover:bg-zinc-100">
                            <div class="flex items-center space-x-1">
                                <span>Usage</span>
                                @if($sortBy === 'usage_count')
                                    <flux:icon name="{{ $sortDirection === 'asc' ? 'chevron-up' : 'chevron-down' }}" class="w-3 h-3" />
                                @endif
                            </div>
                        </th>
                        <th wire:click="sortBy('is_active')" class="cursor-pointer px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-zinc-500 hover:bg-zinc-100">
                            <div class="flex items-center space-x-1">
                                <span>Status</span>
                                @if($sortBy === 'is_active')
                                    <flux:icon name="{{ $sortDirection === 'asc' ? 'chevron-up' : 'chevron-down' }}" class="w-3 h-3" />
                                @endif
                            </div>
                        </th>
                        <th wire:click="sortBy('updated_at')" class="cursor-pointer px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-zinc-500 hover:bg-zinc-100">
                            <div class="flex items-center space-x-1">
                                <span>Last Updated</span>
                                @if($sortBy === 'updated_at')
                                    <flux:icon name="{{ $sortDirection === 'asc' ? 'chevron-up' : 'chevron-down' }}" class="w-3 h-3" />
                                @endif
                            </div>
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-zinc-500">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-zinc-200 bg-white">
                    @forelse($mappings as $mapping)
                        <tr class="hover:bg-zinc-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div>
                                    <div class="text-sm font-medium text-zinc-900">{{ $mapping->platform_sku }}</div>
                                    @if($mapping->platform_product_name)
                                        <div class="text-sm text-zinc-500">{{ $mapping->platform_product_name }}</div>
                                    @endif
                                    @if($mapping->platform_variation_name)
                                        <div class="text-xs text-zinc-400">{{ $mapping->platform_variation_name }}</div>
                                    @endif
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    @if($mapping->platform->logo_url)
                                        <img class="h-8 w-8 rounded-lg mr-3" src="{{ $mapping->platform->logo_url }}" alt="{{ $mapping->platform->name }}">
                                    @endif
                                    <div>
                                        <div class="text-sm font-medium text-zinc-900">{{ $mapping->platform->name }}</div>
                                        @if($mapping->platformAccount)
                                            <div class="text-xs text-zinc-500">{{ $mapping->platformAccount->name }}</div>
                                        @endif
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                @if($mapping->product)
                                    <div>
                                        <div class="text-sm font-medium text-zinc-900">
                                            {{ $mapping->product->name }}
                                            @if($mapping->productVariant)
                                                <span class="text-zinc-500">- {{ $mapping->productVariant->name }}</span>
                                            @endif
                                        </div>
                                        <div class="text-sm text-zinc-500">
                                            SKU: {{ $mapping->productVariant?->sku ?? $mapping->product->sku }}
                                        </div>
                                    </div>
                                @else
                                    <span class="text-zinc-400">No product linked</span>
                                @endif
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-zinc-900">{{ number_format($mapping->usage_count) }}</div>
                                @if($mapping->last_used_at)
                                    <div class="text-xs text-zinc-500">Last: {{ $mapping->last_used_at->diffForHumans() }}</div>
                                @endif
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <flux:badge variant="{{ $mapping->is_active ? 'green' : 'gray' }}">
                                    {{ $mapping->is_active ? 'Active' : 'Inactive' }}
                                </flux:badge>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-zinc-500">
                                {{ $mapping->updated_at->diffForHumans() }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex items-center justify-end space-x-2">
                                    <flux:button
                                        variant="outline"
                                        size="sm"
                                        :href="route('platforms.sku-mappings.show', $mapping)"
                                        wire:navigate
                                    >
                                        <flux:icon name="eye" class="w-4 h-4" />
                                    </flux:button>

                                    <flux:button
                                        variant="outline"
                                        size="sm"
                                        :href="route('platforms.sku-mappings.edit', $mapping)"
                                        wire:navigate
                                    >
                                        <flux:icon name="pencil" class="w-4 h-4" />
                                    </flux:button>

                                    <flux:button
                                        variant="outline"
                                        size="sm"
                                        wire:click="toggleStatus({{ $mapping->id }})"
                                    >
                                        <flux:icon name="{{ $mapping->is_active ? 'pause' : 'play' }}" class="w-4 h-4" />
                                    </flux:button>

                                    <flux:button
                                        variant="danger"
                                        size="sm"
                                        wire:click="deleteMapping({{ $mapping->id }})"
                                        wire:confirm="Are you sure you want to delete this SKU mapping?"
                                    >
                                        <flux:icon name="trash" class="w-4 h-4" />
                                    </flux:button>
                                </div>
                            </td>
                        </tr>
                    @empty
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center">
                                    <flux:icon name="code-bracket" class="mx-auto h-12 w-12 text-zinc-400" />
                                    <div class="mt-4">
                                        <flux:heading size="lg" class="text-zinc-900">No SKU mappings found</flux:heading>
                                        <flux:text class="mt-2 text-zinc-500">
                                            @if($search || $platformFilter || $statusFilter || $productFilter)
                                                Try adjusting your filters or search terms.
                                            @else
                                                Get started by creating your first SKU mapping.
                                            @endif
                                        </flux:text>
                                    </div>
                                    @if(!$search && !$platformFilter && !$statusFilter && !$productFilter)
                                        <div class="mt-6">
                                            <flux:button variant="primary" :href="route('platforms.sku-mappings.create')" wire:navigate>
                                                <flux:icon name="plus" class="w-4 h-4 mr-2" />
                                                Create First Mapping
                                            </flux:button>
                                        </div>
                                    @endif
                                </div>
                            </td>
                        </tr>
                    @endforelse
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    @if($mappings->hasPages())
        <div class="mt-6">
            {{ $mappings->links() }}
        </div>
    @endif

    <!-- Summary Stats -->
    <div class="mt-8 grid grid-cols-1 gap-4 sm:grid-cols-4">
        <div class="rounded-lg border border-zinc-200 bg-white p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <flux:icon name="code-bracket" class="h-8 w-8 text-blue-500" />
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-zinc-500 truncate">Total Mappings</dt>
                        <dd class="text-lg font-medium text-zinc-900">{{ $mappings->total() }}</dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="rounded-lg border border-zinc-200 bg-white p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <flux:icon name="check-circle" class="h-8 w-8 text-green-500" />
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-zinc-500 truncate">Active Mappings</dt>
                        <dd class="text-lg font-medium text-zinc-900">
                            {{ PlatformSkuMapping::where('is_active', true)->count() }}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="rounded-lg border border-zinc-200 bg-white p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <flux:icon name="squares-2x2" class="h-8 w-8 text-purple-500" />
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-zinc-500 truncate">Platforms</dt>
                        <dd class="text-lg font-medium text-zinc-900">{{ $platforms->count() }}</dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="rounded-lg border border-zinc-200 bg-white p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <flux:icon name="cube" class="h-8 w-8 text-orange-500" />
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-zinc-500 truncate">Mapped Products</dt>
                        <dd class="text-lg font-medium text-zinc-900">
                            {{ PlatformSkuMapping::distinct('product_id')->whereNotNull('product_id')->count() }}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</x-admin.layout>